<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>FreeLand - Tradable Posts</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #000;
      --card: #111;
      --border: #333;
      --primary: #2e5bff;
      --green: #00c48c;
      --red: #ff4757;
      --gold: #ffd700;
      --text: #fff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    #app {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    .hide { display: none !important; }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    #auth {
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding: 40px 20px;
      max-width: 400px;
      margin: 100px auto;
      animation: fadeIn 0.5s ease;
    }

    #auth h1 {
      font-size: 32px;
      text-align: center;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }

    input, textarea {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
      transition: all 0.3s ease;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 91, 255, 0.1);
      transform: translateY(-2px);
    }

    button {
      background: var(--primary);
      color: var(--text);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(46, 91, 255, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button.liked { 
      background: var(--red); 
    }

    button.reshared { 
      background: var(--green); 
    }

    button.owned { 
      background: var(--gold); 
      color: #000; 
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--card), #1a1a1a);
      border-radius: 12px;
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      animation: slideIn 0.5s ease;
    }

    #balance {
      font-size: 24px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    #dm-status {
      font-size: 12px;
      color: var(--gold);
      margin-top: 5px;
    }

    #header button {
      padding: 8px 16px;
      font-size: 14px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    #compose {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      animation: slideIn 0.6s ease;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    #compose:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 20px rgba(46, 91, 255, 0.2);
    }

    #text {
      min-height: 80px;
      resize: vertical;
      margin-bottom: 10px;
    }

    #char-count {
      text-align: right;
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
    }

    .post {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      contain: layout style paint;
      will-change: transform;
      animation: slideIn 0.3s ease;
      transition: all 0.3s ease;
    }

    .post:hover {
      border-color: var(--primary);
      transform: translateX(5px);
      box-shadow: 0 4px 20px rgba(46, 91, 255, 0.2);
    }

    .post.reshared-post {
      border-left: 4px solid var(--green);
      background: linear-gradient(to right, rgba(0,196,140,0.05), var(--card));
    }

    .post .header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .post .header span:first-child {
      font-weight: bold;
      color: var(--primary);
    }

    .value {
      color: var(--green);
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    .post p {
      margin: 15px 0;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .original-post {
      background: rgba(46, 91, 255, 0.1);
      border-left: 3px solid var(--primary);
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      font-size: 14px;
    }

    .original-post .author {
      color: var(--primary);
      font-weight: bold;
      margin-bottom: 5px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .actions button {
      flex: 1;
      padding: 8px;
      font-size: 14px;
      min-width: 80px;
    }

    #dashboard, #portfolio-view, #dm-view {
      animation: slideIn 0.5s ease;
    }

    #dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .stat {
      background: linear-gradient(135deg, var(--card), #1a1a1a);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease;
    }

    .stat:hover {
      transform: translateY(-5px);
      border-color: var(--primary);
      box-shadow: 0 10px 30px rgba(46, 91, 255, 0.3);
    }

    .stat h3 {
      font-size: 14px;
      color: #888;
      margin-bottom: 10px;
    }

    .stat p {
      font-size: 28px;
      font-weight: bold;
    }

    .stat small {
      font-size: 14px;
    }

    .profit { color: var(--green); }
    .loss { color: var(--red); }

    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      border: 1px solid var(--primary);
      padding: 15px 20px;
      border-radius: 8px;
      animation: slideIn 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(46, 91, 255, 0.4);
      max-width: 300px;
    }

    #modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--card);
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      animation: slideIn 0.3s ease;
      border: 1px solid var(--primary);
    }

    .modal-content h2 {
      margin-bottom: 20px;
    }

    .modal-content textarea {
      width: 100%;
      margin-bottom: 15px;
    }

    .modal-content .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-content .btn-group button {
      flex: 1;
    }

    .progress-bar {
      background: var(--border);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--primary), var(--green));
      height: 100%;
      transition: width 0.25s ease;
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }

    #leaderboard {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      animation: slideIn 0.5s ease;
    }

    #leaderboard h2 {
      margin: 20px 0 10px 0;
      font-size: 18px;
    }

    .rank {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .rank:hover {
      background: rgba(46, 91, 255, 0.1);
      transform: translateX(5px);
    }

    .portfolio-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .portfolio-item:hover {
      border-color: var(--primary);
      transform: translateX(5px);
    }

    .portfolio-item .header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .portfolio-item button {
      margin-top: 10px;
      width: 100%;
    }

    #dm-view {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
    }

    #messages {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
    }

    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      animation: slideIn 0.3s ease;
    }

    .message.sent {
      background: var(--primary);
      margin-left: 20%;
      text-align: right;
    }

    .message.received {
      background: var(--card);
      margin-right: 20%;
      border: 1px solid var(--border);
    }

    .message .username {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 5px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      #app {
        padding: 10px;
      }

      .actions {
        flex-direction: column;
      }

      .btn-group {
        flex-wrap: wrap;
      }
    }

    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--primary);
      animation: confetti 3s ease-out forwards;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="auth">
      <h1>üèùÔ∏è FreeLand</h1>
      <input id="user" placeholder="Username" autocomplete="username">
      <input id="pass" type="password" placeholder="Password" autocomplete="current-password">
      <button onclick="auth(true)">Sign Up</button>
      <button onclick="auth(false)">Log In</button>
    </div>

    <div id="main" class="hide">
      <div id="header">
        <div>
          <div id="balance">üí∞ 100</div>
          <div id="dm-status"></div>
        </div>
        <div class="btn-group">
          <button onclick="showView('feed')">Feed</button>
          <button onclick="showView('dashboard')">Stats</button>
          <button onclick="showView('portfolio')">Portfolio</button>
          <button onclick="showView('leaderboard')">Top</button>
          <button onclick="showView('dm')">DM</button>
          <button onclick="logout()">Exit</button>
        </div>
      </div>

      <div id="compose">
        <textarea id="text" maxlength="280" placeholder="What's happening?"></textarea>
        <div id="char-count">0 / 280</div>
        <button onclick="createPost()">Post</button>
      </div>

      <div id="feed"></div>
      <div id="dashboard" class="hide"></div>
      <div id="portfolio-view" class="hide"></div>
      <div id="leaderboard" class="hide"></div>
      <div id="dm-view" class="hide"></div>
    </div>
  </div>

  <script>
    let ws, uid, username
    const auth_div = document.getElementById('auth')
    const main_div = document.getElementById('main')
    const feed = document.getElementById('feed')
    const balance = document.getElementById('balance')
    const dashboard = document.getElementById('dashboard')
    const leaderboard = document.getElementById('leaderboard')
    const compose = document.getElementById('compose')
    const portfolioView = document.getElementById('portfolio-view')
    const dmView = document.getElementById('dm-view')
    const dmStatus = document.getElementById('dm-status')

    document.getElementById('text').addEventListener('input', (e) => {
      const count = e.target.value.length
      document.getElementById('char-count').textContent = count + ' / 280'
      document.getElementById('char-count').style.color = count > 260 ? 'var(--red)' : '#888'
    })

    async function auth(signup) {
      const u = document.getElementById('user').value.trim()
      const p = document.getElementById('pass').value

      if (!u || u.length < 3 || u.length > 20 || !p || p.length < 8) {
        showNotification('Username must be 3-20 chars, password min 8 chars')
        return
      }

      const res = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: u, password: p, signup })
      })

      if (!res.ok) {
        const err = await res.json()
        showNotification(err.error || 'Authentication failed')
        return
      }

      const data = await res.json()
      uid = data.id
      username = data.username
      balance.textContent = 'üí∞ ' + data.coins

      updateDMStatus(data.dm_until)

      document.getElementById('user').value = ''
      document.getElementById('pass').value = ''

      auth_div.classList.add('hide')
      main_div.classList.remove('hide')

      connectWS()
      loadFeed()
      showConfetti()
    }

    function updateDMStatus(dmUntil) {
      if (dmUntil && dmUntil > Date.now()) {
        const remaining = Math.ceil((dmUntil - Date.now()) / 60000)
        dmStatus.textContent = `DM Active (${remaining}min left)`
        dmStatus.style.color = 'var(--gold)'
      } else {
        dmStatus.textContent = 'DM Locked (50 coins/hour)'
        dmStatus.style.color = '#888'
      }
    }

    function connectWS() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:'
      ws = new WebSocket(`${protocol}//${location.host}/ws`)

      ws.onopen = () => {
        showNotification('Connected! üéâ')
      }

      ws.onmessage = (e) => {
        const { t, d } = JSON.parse(e.data)

        if (t === 'new') addPost(d)

        if (t === 'remove') {
          const posts = document.querySelectorAll('.post')
          posts.forEach(post => {
            if (post.dataset.userId == d.uid && post.dataset.originalId == d.original_id) {
              post.remove()
            }
          })
        }

        if (t === 'update') {
          updatePostUI(d)
        }

        if (t === 'balance') {
          balance.textContent = 'üí∞ ' + d.coins
          showNotification(d.msg)
        }

        if (t === 'success') {
          showNotification(d.msg)
        }

        if (t === 'error') {
          showNotification(d.msg)
        }

        if (t === 'dm_active') {
          updateDMStatus(d.dm_until)
          balance.textContent = 'üí∞ ' + d.coins
          showNotification(d.msg)
          showConfetti()
        }

        if (t === 'message') {
          addMessage(d)
        }

        if (t === 'progress') {
          updateProgress(d.id, d.p)
        }
      }

      ws.onerror = () => showNotification('Connection error')
      ws.onclose = () => showNotification('Disconnected')
    }

    function updatePostUI(d) {
      const likeBtn = document.getElementById('likebtn' + d.id)
      const reshareBtn = document.getElementById('resharebtn' + d.id)
      const buyBtn = document.getElementById('buybtn' + d.id)
      const sellBtn = document.getElementById('sellbtn' + d.id)
      const likeCount = document.getElementById('lc' + d.id)
      const reshareCount = document.getElementById('rc' + d.id)
      const valueEl = document.getElementById('v' + d.id)

      if (d.like_count !== undefined && likeCount) {
        likeCount.textContent = d.like_count
      }

      if (d.reshare_count !== undefined && reshareCount) {
        reshareCount.textContent = d.reshare_count
      }

      if (d.value !== undefined && valueEl) {
        valueEl.textContent = 'üí∞ ' + d.value
      }

      if (d.user_id === uid) {
        if (d.liked !== undefined && likeBtn) {
          if (d.liked) {
            likeBtn.classList.add('liked')
          } else {
            likeBtn.classList.remove('liked')
          }
        }

        if (d.reshared !== undefined && reshareBtn) {
          if (d.reshared) {
            reshareBtn.classList.add('reshared')
          } else {
            reshareBtn.classList.remove('reshared')
          }
        }

        if (d.owns !== undefined && sellBtn) {
          if (d.owns) {
            sellBtn.classList.add('owned')
            sellBtn.textContent = 'üìâ Sell (Owned)'
          } else {
            sellBtn.classList.remove('owned')
            sellBtn.textContent = 'üìâ Sell'
          }
        }
      }
    }

    async function loadFeed() {
      const res = await fetch(`/api/feed?uid=${uid}`)
      const posts = await res.json()
      feed.innerHTML = ''
      posts.forEach(p => addPost(p))
    }

    function addPost(p) {
      const el = document.createElement('div')
      el.className = 'post'
      if (p.original_post_id) el.className += ' reshared-post'
      el.id = 'p' + p.id
      el.dataset.userId = p.user_id
      el.dataset.originalId = p.original_post_id || ''

      let originalHTML = ''
      if (p.original_post_id && p.original_text) {
        originalHTML = `
          <div class="original-post">
            <div class="author">üîÑ Originally by @${escapeHtml(p.original_author)}</div>
            <div>${escapeHtml(p.original_text)}</div>
          </div>
        `
      }

      const likedClass = p.user_liked ? 'liked' : ''
      const resharedClass = p.user_reshared ? 'reshared' : ''
      const ownedClass = p.user_owns ? 'owned' : ''
      const sellText = p.user_owns ? 'üìâ Sell (Owned)' : 'üìâ Sell'

      el.innerHTML = `
        <div class="header">
          <span>@${escapeHtml(p.username)}</span>
          <span class="value" id="v${p.id}">üí∞ ${p.value}</span>
        </div>
        ${p.text ? '<p>' + escapeHtml(p.text) + '</p>' : ''}
        ${originalHTML}
        <div class="actions">
          <button id="likebtn${p.id}" class="${likedClass}" onclick="like(${p.id})">‚ù§Ô∏è <span id="lc${p.id}">${p.like_count}</span></button>
          <button id="resharebtn${p.id}" class="${resharedClass}" onclick="openReshareModal(${p.id})">üîÑ <span id="rc${p.id}">${p.reshare_count}</span></button>
          <button id="buybtn${p.id}" onclick="buy(${p.id})">üìà Buy</button>
          <button id="sellbtn${p.id}" class="${ownedClass}" onclick="sell(${p.id})">${sellText}</button>
        </div>
      `
      feed.prepend(el)
    }

    function createPost() {
      const text = document.getElementById('text').value.trim()
      if (!text || text.length > 280) {
        showNotification('Post must be 1-280 characters')
        return
      }
      ws.send(JSON.stringify({ t: 'post', d: { uid, text } }))
      document.getElementById('text').value = ''
      document.getElementById('char-count').textContent = '0 / 280'
    }

    function like(id) {
      ws.send(JSON.stringify({ t: 'like', d: { uid, id } }))
    }

    function openReshareModal(id) {
      const modal = document.createElement('div')
      modal.id = 'modal'
      modal.innerHTML = `
        <div class="modal-content">
          <h2>Reshare Post</h2>
          <textarea id="reshare-text" placeholder="Add your comment (optional)" maxlength="280"></textarea>
          <label class="checkbox-label">
            <input type="checkbox" id="show-original" checked>
            <span>Show original post (allows auto-sell)</span>
          </label>
          <div class="btn-group">
            <button onclick="reshare(${id})">Reshare</button>
            <button onclick="closeReshareModal()">Cancel</button>
          </div>
        </div>
      `
      document.body.appendChild(modal)
    }

    function closeReshareModal() {
      const modal = document.getElementById('modal')
      if (modal) modal.remove()
    }

    function reshare(id) {
      const text = document.getElementById('reshare-text')?.value.trim() || ''
      const showOriginal = document.getElementById('show-original')?.checked
      ws.send(JSON.stringify({ t: 'reshare', d: { uid, id, text, show_original: showOriginal } }))
      closeReshareModal()
    }

    function buy(id) {
      ws.send(JSON.stringify({ t: 'buy', d: { uid, id } }))
    }

    function sell(id) {
      ws.send(JSON.stringify({ t: 'sell', d: { uid, id } }))
    }

    async function showView(view) {
      feed.classList.add('hide')
      dashboard.classList.add('hide')
      leaderboard.classList.add('hide')
      compose.classList.add('hide')
      portfolioView.classList.add('hide')
      dmView.classList.add('hide')

      if (view === 'feed') {
        feed.classList.remove('hide')
        compose.classList.remove('hide')
        await loadFeed()
      } else if (view === 'dashboard') {
        dashboard.classList.remove('hide')
        await loadDashboard()
      } else if (view === 'portfolio') {
        portfolioView.classList.remove('hide')
        await loadPortfolio()
      } else if (view === 'leaderboard') {
        leaderboard.classList.remove('hide')
        await loadLeaderboard()
      } else if (view === 'dm') {
        dmView.classList.remove('hide')
        await loadDM()
      }
    }

    async function loadDashboard() {
      const res = await fetch(`/api/stats?uid=${uid}`)
      const data = await res.json()

      const roiClass = data.roi >= 0 ? 'profit' : 'loss'

      dashboard.innerHTML = `
        <div class="stat">
          <h3>üí∞ Balance</h3>
          <p>${data.coins}</p>
        </div>
        <div class="stat">
          <h3>üìù Posts</h3>
          <p>${data.post_count}</p>
        </div>
        <div class="stat">
          <h3>üìà Portfolio</h3>
          <p>${data.portfolio_value}</p>
          <small class="${roiClass}">${data.roi > 0 ? '+' : ''}${data.roi}%</small>
        </div>
        <div class="stat">
          <h3>üí¨ DM Status</h3>
          <p>${data.dm_active ? '‚úÖ' : 'üîí'}</p>
          ${!data.dm_active ? '<button onclick="buyDM()" style="margin-top:10px;padding:8px">Unlock (50üí∞)</button>' : ''}
        </div>
      `
    }

    async function loadPortfolio() {
      portfolioView.innerHTML = '<h2 style="margin-bottom:20px">Your Portfolio</h2><div id="portfolio-list"></div>'
      const list = document.getElementById('portfolio-list')

      try {
        const res = await fetch(`/api/portfolio?uid=${uid}`)
        const items = await res.json()

        if (items.length === 0) {
          list.innerHTML = '<p style="text-align:center;color:#888">No assets yet. Buy some posts to start investing!</p>'
          return
        }

        list.innerHTML = items.map(item => {
          const profit = item.current_value - item.buy_price
          const profitClass = profit >= 0 ? 'profit' : 'loss'
          const profitSign = profit > 0 ? '+' : ''

          return `
            <div class="portfolio-item">
              <div class="header">
                <span>@${escapeHtml(item.author)}</span>
                <span class="${profitClass}">${profitSign}${profit} (${profitSign}${Math.round((profit/item.buy_price)*100)}%)</span>
              </div>
              <p>${escapeHtml(item.text.slice(0, 100))}${item.text.length > 100 ? '...' : ''}</p>
              <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:14px;color:#888">
                <span>Bought: üí∞${item.buy_price}</span>
                <span>Now: üí∞${item.current_value}</span>
              </div>
              <button onclick="sell(${item.post_id})" class="owned">Sell for üí∞${item.current_value}</button>
            </div>
          `
        }).join('')
      } catch (err) {
        list.innerHTML = '<p style="text-align:center;color:var(--red)">Error loading portfolio</p>'
      }
    }

    async function loadLeaderboard() {
      const res = await fetch('/api/leaderboard')
      const data = await res.json()

      leaderboard.innerHTML = `
        <h2>üí∞ Richest Users</h2>
        ${data.richest.map((u, i) => `
          <div class="rank">
            <span>${i + 1}. @${escapeHtml(u.username)}</span>
            <span>üí∞ ${u.coins}</span>
          </div>
        `).join('')}

        <h2>üìà Most Valuable Posts</h2>
        ${data.valuable.map((p, i) => `
          <div class="rank">
            <span>${i + 1}. ${escapeHtml(p.text.slice(0, 40))}${p.text.length > 40 ? '...' : ''}</span>
            <span>üí∞ ${p.value}</span>
          </div>
        `).join('')}

        <h2>üèÜ Top Traders</h2>
        ${data.traders.map((t, i) => `
          <div class="rank">
            <span>${i + 1}. @${escapeHtml(t.username)}</span>
            <span>${t.trades} trades</span>
          </div>
        `).join('')}
      `
    }

    async function loadDM() {
      dmView.innerHTML = `
        <h2>üí¨ Direct Messages</h2>
        <div id="messages"></div>
        <div>
          <input id="dm-to" placeholder="Username to message" style="width:100%;margin-bottom:10px">
          <textarea id="dm-text" placeholder="Type your message..." maxlength="500"></textarea>
          <button onclick="sendMessage()">Send Message</button>
        </div>
      `
    }

    function buyDM() {
      ws.send(JSON.stringify({ t: 'buy_dm', d: { uid } }))
    }

    function sendMessage() {
      const toUsername = document.getElementById('dm-to').value.trim()
      const text = document.getElementById('dm-text').value.trim()

      if (!toUsername || !text) {
        showNotification('Enter username and message')
        return
      }

      ws.send(JSON.stringify({ t: 'send_message', d: { uid, to_id: toUsername, text } }))
      document.getElementById('dm-text').value = ''
    }

    function addMessage(msg) {
      const messagesDiv = document.getElementById('messages')
      if (!messagesDiv) return

      const el = document.createElement('div')
      el.className = 'message ' + (msg.from_id === uid ? 'sent' : 'received')
      el.innerHTML = `
        <div class="username">@${escapeHtml(msg.from_username)}</div>
        <div>${escapeHtml(msg.text)}</div>
      `
      messagesDiv.prepend(el)
    }

    function showNotification(msg) {
      let notif = document.getElementById('notification')
      if (!notif) {
        notif = document.createElement('div')
        notif.id = 'notification'
        document.body.appendChild(notif)
      }
      notif.textContent = msg
      setTimeout(() => notif.remove(), 3000)
    }

    function updateProgress(id, p) {
      let modal = document.getElementById('modal')
      if (!modal && p < 100) {
        modal = document.createElement('div')
        modal.id = 'modal'
        modal.innerHTML = `
          <div class="modal-content">
            <h2>Sending Coins...</h2>
            <div class="progress-bar">
              <div class="progress-fill" id="fill-${id}" style="width:0%"></div>
            </div>
          </div>
        `
        document.body.appendChild(modal)
      }

      const fill = document.getElementById('fill-' + id)
      if (fill) fill.style.width = p + '%'

      if (p >= 100) {
        setTimeout(() => {
          if (modal) modal.remove()
          showConfetti()
        }, 500)
      }
    }

    function logout() {
      if (ws) ws.close()
      uid = null
      username = null
      document.getElementById('user').value = ''
      document.getElementById('pass').value = ''
      main_div.classList.add('hide')
      auth_div.classList.remove('hide')
      feed.innerHTML = ''
    }

    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }

    function showConfetti() {
      const colors = ['#2e5bff', '#00c48c', '#ffd700', '#ff4757']
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div')
          confetti.className = 'confetti'
          confetti.style.left = Math.random() * 100 + 'vw'
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)]
          confetti.style.animationDelay = Math.random() * 0.5 + 's'
          document.body.appendChild(confetti)
          setTimeout(() => confetti.remove(), 3000)
        }, i * 30)
      }
    }

    document.getElementById('text').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) createPost()
    })
  </script>
</body>
</html>
